<?xml version="1.0" encoding="UTF-8"?>
<project name="{module}" default="deploy" basedir=".">

  <property environment="env"/>
  <property file="build.properties"/>

  <path id="classpath">
    <pathelement location="build"/>
    <pathelement location="src"/>
    <pathelement location="${gwt.dir}/gwt-user.jar"/>
    <!-- next line is platform-specific -->
    <pathelement location="${gwt.dir}/gwt-dev.jar"/>
    <pathelement location="${gwt.dir}/gwt-servlet.jar"/>
    <pathelement location="${junit.jar}"/>
    <pathelement location="${servlet-api.jar}"/>
  </path>
  
  <target name="clean" depends="clean.test"
   description="deletes all generated files">
    <delete dir=".gwt-cache"/> <!-- generated by GWT -->
    <delete dir="build"/> <!-- generated by the prepare target -->
    <delete dir="tomcat"/> <!-- generated by GWT -->
  </target>

  <target name="clean.test" description="deletes all generated test files">
    <delete dir="test"/>
  </target>

  <target name="compile" depends="prepare"
    description="compiles Java source files to bytecode">
    <javac srcdir="src" destdir="build"
      classpathref="classpath" debug="true">
    </javac>
  </target>

  <target name="compile.gwt" depends="compile"
    description="compiles Java source files to JavaScript">
    <!-- Consider adding -Xms256m -Xmx512m to improve performance. -->
    <java classname="com.google.gwt.dev.GWTCompiler"
      classpathref="classpath" fork="true">
      <arg line="-out build/www"/>
      <arg line="-style OBFUSCATE"/>
      <arg value="${package}.${module}"/>
    </java>
  </target>

  <target name="deploy" depends="war,undeploy"
    description="deploys the war file to Tomcat">
    <copy file="build/${war}" todir="${tomcat.dir}/webapps"/>
    <echo>browse ${url}</echo>
  </target>

  <target name="hosted" depends="compile"
    description="runs the application in hosted mode">
    <java classname="com.google.gwt.dev.GWTShell"
      classpathref="classpath" fork="true">
      <!-- next line is only for Mac OS X -->
      <arg line="-out ./www"/>
      <arg line="${package}.${module}/${module}.html"/>
    </java>
  </target>

  <target name="prepare" description="creates output directories">
    <mkdir dir="build"/>
  </target>

  <target name="test" depends="clean.test,compile"
    description="runs all JUnit tests">
    <mkdir dir="test"/>
    <junit fork="yes" printsummary="yes">
     
      <classpath refid="classpath"/>
      <batchtest todir="test">
        <fileset dir="src" includes="**/${test}Test.java"/>
      </batchtest>
      <formatter type="xml"/>
    </junit>
    <junitreport toDir="test">
      <fileset dir="test"/>
      <report format="frames" todir="test"/>
    </junitreport>
    <exec os="Windows" executable="cmd.exe">
      <arg line="/c start test/index.html"/>
    </exec>
    <exec os="Mac OS X" executable="open">
      <arg line="-a /Applications/Safari.app test/index.html"/>
    </exec>
  </target>

  <target name="undeploy" description="undeploys the web app. from Tomcat">
    <delete dir="${tomcat.dir}/webapps/${ant.project.name}"/>
    <delete file="${tomcat.dir}/webapps/${war}"/>
  </target>
  
  <target name="war" depends="compile, compile.gwt"
    description="builds the war file">
    <delete file="build/${war}"/>
    <war warfile="build/${war}" webxml="web.xml">
      <!-- bytecode from your Java code -->
      <classes dir="build" includes="**/*.class"/>
      <!-- generated HTML/JavaScript plus your CSS -->
      <fileset dir="build/www"/>
      <!-- supplied JAR -->
      <lib file="${gwt.dir}/gwt-servlet.jar"/>
    </war>
  </target>

</project>